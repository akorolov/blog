name: Post to Bluesky

on:
  push:
    branches: [main]
    paths:
      - 'src/posts/**.svx'

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new posts
        id: detect
        run: |
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- 'src/posts/*.svx')
          if [ -z "$NEW_FILES" ]; then
            echo "No new posts found"
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          else
            echo "Found new posts: $NEW_FILES"
            echo "has_new=true" >> "$GITHUB_OUTPUT"
            echo "files<<EOF" >> "$GITHUB_OUTPUT"
            echo "$NEW_FILES" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Post to Bluesky
        if: steps.detect.outputs.has_new == 'true'
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
          SITE_URL: https://blog.akorl.xyz
        run: |
          while IFS= read -r file; do
            TITLE=$(sed -n 's/^title: *//p' "$file" | tr -d "'\"")
            DESCRIPTION=$(sed -n 's/^description: *//p' "$file" | tr -d "'\"")

            SLUG=$(basename "$file" .svx)
            POST_URL="${SITE_URL}/${SLUG}"

            TEXT="new blog post alert: ${TITLE}

          ${DESCRIPTION}

          ${POST_URL}"

            AUTH_RESPONSE=$(curl -s -X POST "https://bsky.social/xrpc/com.atproto.server.createSession" \
              -H "Content-Type: application/json" \
              -d "{\"identifier\": \"${BLUESKY_HANDLE}\", \"password\": \"${BLUESKY_APP_PASSWORD}\"}")

            DID=$(echo "$AUTH_RESPONSE" | jq -r '.did')
            ACCESS_TOKEN=$(echo "$AUTH_RESPONSE" | jq -r '.accessJwt')

            if [ "$DID" = "null" ] || [ -z "$DID" ]; then
              echo "Authentication failed"
              exit 1
            fi

            BEFORE_URL="${TEXT%$POST_URL*}"
            URL_BYTE_START=$(echo -n "$BEFORE_URL" | wc -c | tr -d ' ')
            URL_BYTE_END=$((URL_BYTE_START + $(echo -n "$POST_URL" | wc -c | tr -d ' ')))

            NOW=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
            curl -s -X POST "https://bsky.social/xrpc/com.atproto.repo.createRecord" \
              -H "Authorization: Bearer ${ACCESS_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{
                \"repo\": \"${DID}\",
                \"collection\": \"app.bsky.feed.post\",
                \"record\": {
                  \"\$type\": \"app.bsky.feed.post\",
                  \"text\": $(echo "$TEXT" | jq -Rs .),
                  \"createdAt\": \"${NOW}\",
                  \"facets\": [{
                    \"index\": {
                      \"byteStart\": ${URL_BYTE_START},
                      \"byteEnd\": ${URL_BYTE_END}
                    },
                    \"features\": [{
                      \"\$type\": \"app.bsky.richtext.facet#link\",
                      \"uri\": \"${POST_URL}\"
                    }]
                  }]
                }
              }"

            echo "Posted: ${TITLE}"
          done <<< "${{ steps.detect.outputs.files }}"
